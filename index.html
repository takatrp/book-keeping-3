<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
<title>簿記の仕訳トレーナー r3（3級専用）</title>
<meta name="description" content="日商簿記3級 専用の仕訳トレーニング。日常仕訳＋基本の決算整理。許容勘定科目に準拠。練習/本番テスト、制限時間、スコア保存、CSV出力対応。">
<style>
  :root{
    --brand:#578899;
    --bg:#f8fbfd;
    --ink:#1f2937;
    --muted:#6b7785;
    --ok:#2b8a3e;
    --ng:#c92a2a;
    --card:#ffffff;
    --border:#e2e8f0;
    --chip:#eef5f9;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue","Hiragino Kaku Gothic ProN","Hiragino Sans","Noto Sans JP","Yu Gothic",YuGothic,sans-serif; line-height:1.6}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,var(--card),#f6f9fb);border-bottom:1px solid var(--border)}
  .wrap{max-width:860px;margin:0 auto;padding:10px 14px}
  h1{font-size:1.3rem;margin:4px 0;color:var(--brand)}
  .subtitle{font-size:.9rem;color:var(--muted);margin-top:-2px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .col{flex:1 1 160px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;margin:12px 0;box-shadow:0 1px 0 rgba(0,0,0,.02)}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:.2rem .6rem;border:1px solid var(--border);border-radius:999px;background:#fff;color:var(--muted);font-size:.8rem}
  .btn{border:none;padding:11px 14px;border-radius:12px;font-size:1rem;background:var(--brand);color:#fff;box-shadow:0 2px 0 rgba(0,0,0,.06);cursor:pointer}
  .btn.ghost{background:#eef5f9;color:var(--brand)}
  .btn.line{background:#fff;border:1px solid var(--border);color:var(--ink)}
  .btn.sm{font-size:.9rem;padding:8px 10px;border-radius:10px}
  label{display:block;font-size:.9rem;color:var(--muted);margin:8px 0 4px}
  select,input[type="number"],input[type="text"]{width:100%;padding:12px;border-radius:10px;border:1px solid var(--border);font-size:1rem;background:#fff}
  .status{font-size:.95rem;margin-top:8px}
  .ok{color:var(--ok);font-weight:600}
  .ng{color:var(--ng);font-weight:600}
  .tacc{overflow:auto;border:1px solid var(--border);border-radius:12px}
  table{border-collapse:collapse;width:100%;min-width:560px}
  th,td{border-bottom:1px solid var(--border);padding:6px 8px;text-align:right;font-variant-numeric: tabular-nums}
  th:first-child,td:first-child{text-align:left}
  .muted{color:var(--muted)}
  .badge{background:#fff;border:1px solid var(--border);padding:.2rem .5rem;border-radius:8px;margin-left:.3rem}
  .klink a{color:var(--brand);text-decoration:none}
  .chip{display:inline-block;background:var(--chip);border:1px solid var(--border);padding:.2rem .5rem;border-radius:8px;font-size:.8rem;margin-right:.3rem}
  .timer{font-weight:700}
  .foot{font-size:.75rem;color:var(--muted);text-align:center;margin:24px 0}
  .stickybar{position:sticky;bottom:0;z-index:10;background:linear-gradient(180deg,rgba(255,255,255,.0),rgba(255,255,255,.8) 30%,#fff);padding:8px 0}
  .center{text-align:center}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>簿記の仕訳トレーナー <span class="badge">r3｜3級</span></h1>
    <div class="subtitle">対象：日商簿記3級｜範囲：日常仕訳＋基本の決算整理｜科目：許容勘定科目に準拠</div>
  </div>
</header>

<main class="wrap">
  <section class="card" id="mode-card">
    <div class="row" style="align-items:flex-end">
      <div class="col" style="flex:1 1 220px">
        <label>モード</label>
        <select id="mode">
          <option value="practice">練習モード（無制限）</option>
          <option value="exam">本番テスト</option>
        </select>
      </div>
      <div class="col">
        <label>問題数（本番テスト）</label>
        <select id="examCount">
          <option>20</option>
          <option>30</option>
          <option selected>40</option>
        </select>
      </div>
      <div class="col">
        <label>制限時間（分）</label>
        <select id="timeLimit">
          <option>15</option>
          <option>30</option>
          <option selected>60</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="pill">正解: <b id="okCount">0</b></div>
      <div class="pill">不正解: <b id="ngCount">0</b></div>
      <div class="pill">正答率: <b id="rate">-</b></div>
      <div class="pill">進捗: <b id="progress">0/0</b></div>
      <div class="pill">タイマー: <span class="timer" id="timer">--:--</span></div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="startBtn">スタート</button>
      <button class="btn ghost" id="nextBtn">次の問題</button>
      <button class="btn line" id="checkBtn">採点</button>
      <button class="btn line" id="showBtn">正解を見る</button>
      <button class="btn line" id="recordBtn">仕訳帳に記録</button>
      <button class="btn line" id="finishBtn">終了・成績表</button>
      <button class="btn sm line" id="resetBtn">リセット</button>
    </div>
  </section>

  <section class="card" id="problem-card">
    <div class="muted" style="font-size:.85rem">問題（3級｜日常＋決算整理）</div>
    <div id="question" style="font-size:1.05rem;font-weight:600;margin:4px 0 6px">—</div>
    <div class="row">
      <div class="col">
        <label>借方 勘定科目</label>
        <select id="debitAcc"></select>
      </div>
      <div class="col">
        <label>貸方 勘定科目</label>
        <select id="creditAcc"></select>
      </div>
      <div class="col">
        <label>金額（円）</label>
        <input id="amount" type="number" inputmode="numeric" placeholder="例：100000">
      </div>
    </div>
    <div class="status" id="status"></div>
  </section>

  <section class="card" id="explain" style="display:none">
    <div class="muted">解説</div>
    <div id="explainBody">—</div>
    <div class="klink" style="margin-top:8px">
      <span class="chip">根拠リンク：</span>
      <a href="https://links.kentei.ne.jp/competition/assets/pdf/kubun1.pdf" target="_blank" rel="noopener">出題区分表（商業簿記・会計学 3級）</a> ／
      <a href="https://www.kentei.ne.jp/wp/wp-content/uploads/2019/02/2019_kamoku.pdf" target="_blank" rel="noopener">商業簿記 標準・許容勘定科目表（2・3級）</a> ／
      <a href="https://career.jusnet.co.jp/keiri_work/2/02.php" target="_blank" rel="noopener">仕訳の基本（入門）</a>
    </div>
  </section>

  <section class="card">
    <details>
      <summary><b>3級の主な許容勘定科目（抜粋｜標準＋許容）</b></summary>
      <div class="tacc" style="margin-top:8px">
        <table>
          <thead><tr><th>科目</th><th>区分</th><th>通常残高</th><th>備考</th></tr></thead>
          <tbody id="cheats"></tbody>
        </table>
      </div>
      <div class="muted" style="margin-top:4px">※ 正式名称・許容語は上記PDFをご参照ください。問題文の指示がある場合はそちらを優先。</div>
    </details>
  </section>

  <section class="card">
    <details>
      <summary><b>仕訳帳（自分の回答を保存）</b></summary>
      <div class="tacc" style="margin-top:8px">
        <table id="journalTable">
          <thead><tr><th>日付</th><th>モード</th><th>摘要</th><th>借方</th><th>金額</th><th>貸方</th><th>金額</th></tr></thead>
          <tbody id="journalBody"></tbody>
        </table>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn sm line" id="exportJournal">仕訳帳CSV</button>
      </div>
    </details>
  </section>

  <section class="card">
    <details open>
      <summary><b>成績表・履歴（ブラウザ保存）</b></summary>
      <div class="tacc" style="margin-top:8px">
        <table id="histTable">
          <thead><tr><th>日時</th><th>モード</th><th>問題数</th><th>正解</th><th>不正解</th><th>正答率</th><th>所要時間</th></tr></thead>
          <tbody id="histBody"></tbody>
        </table>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn sm line" id="exportHist">履歴CSV</button>
        <button class="btn sm line" id="clearHist">履歴クリア</button>
      </div>
    </details>
  </section>

  <section class="card">
    <details>
      <summary><b>T勘定（学習用・簡易）</b></summary>
      <div class="tacc" style="margin-top:8px">
        <table id="tTable">
          <thead><tr><th>科目</th><th>借方合計</th><th>貸方合計</th><th>差額（借方−貸方）</th></tr></thead>
          <tbody id="tBody"></tbody>
        </table>
      </div>
    </details>
  </section>

  <div class="stickybar">
    <div class="wrap" style="display:flex;gap:10px;flex-wrap:wrap">
      <span class="pill">対象：3級</span>
      <span class="pill">範囲：日常仕訳＋基本の決算整理</span>
      <span class="pill">カラー：#578899</span>
      <span class="pill">© 仕訳トレーナー r3</span>
    </div>
  </div>

  <div class="foot">© 簿記の仕訳トレーナー r3 / 教材用途</div>
</main>

<script>
// ===== 基本データ（3級専用） =====
// 勘定タイプ: A=資産 L=負債 E=純資産 R=収益 X=費用
const accounts = [
  // 資産（標準・許容から代表例）
  {name:"現金", type:"A"}, {name:"当座預金", type:"A"}, {name:"普通預金", type:"A"},
  {name:"売掛金", type:"A"}, {name:"受取手形", type:"A"}, {name:"有価証券", type:"A"},
  {name:"商品", type:"A"}, {name:"繰越商品", type:"A"},
  {name:"前払費用", type:"A"}, {name:"未収収益", type:"A"},
  {name:"仮払金", type:"A"}, {name:"立替金", type:"A"},
  {name:"備品", type:"A"}, {name:"車両運搬具", type:"A"},
  {name:"減価償却累計額", type:"A"}, // 評価勘定（貸方残）
  {name:"消耗品", type:"A"},

  // 負債
  {name:"買掛金", type:"L"}, {name:"支払手形", type:"L"},
  {name:"借入金", type:"L"}, {name:"未払金", type:"L"},
  {name:"前受金", type:"L"}, {name:"前受収益", type:"L"},
  {name:"未払費用", type:"L"},
  {name:"仮受金", type:"L"},
  {name:"貸倒引当金", type:"L"},

  // 純資産（個人）
  {name:"元入金", type:"E"},

  // 収益
  {name:"売上", type:"R"}, {name:"売上戻り高", type:"R"},
  {name:"受取利息", type:"R"}, {name:"受取手数料", type:"R"}, {name:"雑収入", type:"R"},
  {name:"受取家賃", type:"R"},

  // 費用
  {name:"仕入", type:"X"},
  {name:"発送費", type:"X"}, // 荷造運賃
  {name:"給料手当", type:"X"}, {name:"水道光熱費", type:"X"}, {name:"支払家賃", type:"X"},
  {name:"支払利息", type:"X"}, {name:"減価償却費", type:"X"},
  {name:"貸倒損失", type:"X"}, {name:"貸倒引当金繰入", type:"X"},
  {name:"旅費交通費", type:"X"}, {name:"通信費", type:"X"},
  {name:"消耗品費", type:"X"}
];

// チートシート（抜粋）
const cheatRows = [
  ["現金","資産","借方残","もっとも流動性の高い資産"],
  ["当座預金","資産","借方残","小切手・手形決済用"],
  ["普通預金","資産","借方残","銀行預金"],
  ["売掛金","資産","借方残","掛販売の未収金"],
  ["受取手形","資産","借方残","受け取った約束手形"],
  ["商品","資産","借方残","棚卸資産（三分法を前提）"],
  ["繰越商品","資産","借方残","決算整理で使用（期首・期末）"],
  ["前払費用","資産","借方残","費用の繰延（保険料・家賃など）"],
  ["未収収益","資産","借方残","収益の見越（受取利息など）"],
  ["買掛金","負債","貸方残","掛仕入の未払"],
  ["支払手形","負債","貸方残","振出手形の債務"],
  ["未払費用","負債","貸方残","費用の見越（支払利息など）"],
  ["前受金/前受収益","負債","貸方残","収益の繰延（受取家賃など）"],
  ["貸倒引当金","負債","貸方残","売掛金等の評価性引当金"],
  ["元入金","純資産","貸方残","個人企業の資本"],
  ["売上","収益","貸方残","商品販売による収益"],
  ["受取利息","収益","貸方残","預金利息等"],
  ["受取家賃","収益","貸方残","家賃収入"],
  ["仕入","費用","借方残","三分法の売上原価要素"],
  ["発送費","費用","借方残","荷造運賃等"],
  ["給料手当","費用","借方残","人件費"],
  ["減価償却費","費用","借方残","固定資産の費用配分"],
  ["貸倒損失","費用","借方残","回収不能の損失"],
  ["貸倒引当金繰入","費用","借方残","引当金の当期繰入"],
  ["消耗品/消耗品費","資産/費用","—","決算整理で振替あり"],
];

// 出題（3級・日常＋決算整理）
const pool = [
  // 日常
  { tag:"daily", q:"現金で商品を販売し、代金 100,000 円を受け取った。", d:"現金", c:"売上", a:100000, exp:"資産の増加→借方、収益の増加→貸方。" },
  { tag:"daily", q:"商品 200,000 円を掛けで販売した。", d:"売掛金", c:"売上", a:200000, exp:"売掛金（資産）増→借方、売上（収益）増→貸方。" },
  { tag:"daily", q:"商品 150,000 円を現金で仕入れた。", d:"仕入", c:"現金", a:150000, exp:"仕入（費用）増→借方、現金（資産）減→貸方。" },
  { tag:"daily", q:"商品 120,000 円を掛けで仕入れた。", d:"仕入", c:"買掛金", a:120000, exp:"仕入（費用）増→借方、買掛金（負債）増→貸方。" },
  { tag:"daily", q:"掛け先から売掛金 200,000 円の入金を普通預金で受け取った。", d:"普通預金", c:"売掛金", a:200000, exp:"普通預金（資産）増、売掛金（資産）減。" },
  { tag:"daily", q:"仕入先へ 10,000 円分の返品を行い、買掛金と相殺した。", d:"買掛金", c:"仕入", a:10000, exp:"買掛金（負債）減→借方、仕入（費用）減→貸方。" },
  { tag:"daily", q:"備品 300,000 円を現金で購入した。", d:"備品", c:"現金", a:300000, exp:"備品（資産）増、現金（資産）減。" },
  { tag:"daily", q:"水道光熱費 12,000 円を普通預金から支払った。", d:"水道光熱費", c:"普通預金", a:12000, exp:"費用の増加→借方、資産の減少→貸方。" },
  { tag:"daily", q:"金融機関から 1,000,000 円を借入れ、現金で受け取った。", d:"現金", c:"借入金", a:1000000, exp:"資産増と負債増。" },
  { tag:"daily", q:"受取利息 1,000 円を現金で受け取った。", d:"現金", c:"受取利息", a:1000, exp:"資産増と収益増。" },
  { tag:"daily", q:"売掛金 10,000 円が貸倒れとなった。", d:"貸倒損失", c:"売掛金", a:10000, exp:"費用増と資産減。" },
  { tag:"daily", q:"発送費 3,000 円を現金で支払った。", d:"発送費", c:"現金", a:3000, exp:"費用増と資産減。" },
  { tag:"daily", q:"従業員へ仮払金 5,000 円を現金で渡した。", d:"仮払金", c:"現金", a:5000, exp:"資産の振替（資産増と資産減）。" },

  // 決算整理（基本）
  { tag:"closing", q:"備品の当期分減価償却 10,000 円を計上する。", d:"減価償却費", c:"減価償却累計額", a:10000, exp:"費用計上と評価勘定（累計額）の増加。" },
  { tag:"closing", q:"当期の受取利息のうち、まだ受け取っていない 2,000 円を見越計上する。", d:"未収収益", c:"受取利息", a:2000, exp:"収益の見越：資産増・収益増。" },
  { tag:"closing", q:"当期の支払利息のうち、まだ支払っていない 2,000 円を見越計上する。", d:"支払利息", c:"未払費用", a:2000, exp:"費用の見越：費用増・負債増。" },
  { tag:"closing", q:"前払していた家賃 60,000 円のうち、当期の費用に該当する 20,000 円を振替える。", d:"支払家賃", c:"前払費用", a:20000, exp:"費用の繰延の取り崩し：費用増・資産減。" },
  { tag:"closing", q:"受け取っていた手付金（家賃） 30,000 円のうち、当期分 10,000 円を収益に振替える。", d:"前受収益", c:"受取家賃", a:10000, exp:"収益の繰延の取り崩し：負債減・収益増。" },
  { tag:"closing", q:"期首商品繰越 80,000 円を取り崩す（三分法）。", d:"仕入", c:"繰越商品", a:80000, exp:"期首繰越の戻し仕訳：原価へ振替。" },
  { tag:"closing", q:"期末商品繰越 100,000 円を計上する（三分法）。", d:"繰越商品", c:"仕入", a:100000, exp:"期末在庫計上：資産計上と原価減少。" },
  { tag:"closing", q:"期末に未使用の消耗品 5,000 円がある。期中は消耗品費で処理していたため振替える。", d:"消耗品", c:"消耗品費", a:5000, exp:"費用の繰延（資産計上）。" },
  { tag:"closing", q:"売掛金に対して貸倒引当金 3,000 円を設定する（繰入）。", d:"貸倒引当金繰入", c:"貸倒引当金", a:3000, exp:"評価性引当金の設定：費用計上と負債（評価）増。" }
];

// 参照：タイプ説明（ヒント用に使用可能）
const mapType = {A:"資産",L:"負債",E:"純資産",R:"収益",X:"費用"};

// ===== 変数 =====
let current = null;
let ok = 0, ng = 0, answered = 0;
let mode = "practice";
let examRemaining = 0;
let examTotal = 0;
let startTime = null;
let timerId = null;
const ledger = {};

// ===== 要素 =====
const modeSel = document.getElementById('mode');
const examCountSel = document.getElementById('examCount');
const timeLimitSel = document.getElementById('timeLimit');
const okEl = document.getElementById('okCount');
const ngEl = document.getElementById('ngCount');
const rateEl = document.getElementById('rate');
const progressEl = document.getElementById('progress');
const timerEl = document.getElementById('timer');
const qEl = document.getElementById('question');
const debitSel = document.getElementById('debitAcc');
const creditSel = document.getElementById('creditAcc');
const amountInp = document.getElementById('amount');
const statusEl = document.getElementById('status');
const explainBox = document.getElementById('explain');
const explainBody = document.getElementById('explainBody');
const journalBody = document.getElementById('journalBody');
const tBody = document.getElementById('tBody');
const histBody = document.getElementById('histBody');

// ===== 初期化 =====
function fillSelect(sel){
  sel.innerHTML="";
  accounts.forEach(acc=>{
    const opt = document.createElement('option');
    opt.value = acc.name; opt.textContent = acc.name; sel.appendChild(opt);
  });
}
fillSelect(debitSel); fillSelect(creditSel);

// 成績履歴の表示
function loadHist(){
  histBody.innerHTML="";
  const hist = JSON.parse(localStorage.getItem('shiwake_hist')||'[]');
  hist.forEach(h=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${h.at}</td><td>${h.mode}</td><td>${h.total}</td><td>${h.ok}</td><td>${h.ng}</td><td>${h.rate}%</td><td>${h.duration}</td>`;
    histBody.appendChild(tr);
  });
}
loadHist();

// 進捗・スコア
function updateScore(){
  okEl.textContent = ok; ngEl.textContent = ng;
  const total = ok+ng;
  rateEl.textContent = total? Math.round(ok*100/total) + "%" : "-";
  progressEl.textContent = mode==="exam" ? `${answered}/${examTotal}` : `${total}/${total}`;
}
function setStatus(msg, cls){ statusEl.innerHTML = `<span class="${cls||""}">${msg}</span>`; }

// タイマー
function startTimer(mins){
  stopTimer();
  const end = Date.now() + mins*60*1000;
  timerId = setInterval(()=>{
    const rem = end - Date.now();
    if(rem<=0){ timerEl.textContent = "00:00"; stopTimer(); finishExam(true); return; }
    const m = Math.floor(rem/60000), s = Math.floor((rem%60000)/1000);
    timerEl.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  }, 200);
}
function stopTimer(){ if(timerId){ clearInterval(timerId); timerId=null; }}

// 問題選択（モードごとにdaily/closingを織り交ぜる）
function pick(){
  // 練習：完全ランダム、テスト：daily:closing=3:2 比率でサンプル
  let candidates = pool;
  if(mode==="exam"){
    const r = Math.random();
    if(r<0.6){ candidates = pool.filter(p=>p.tag==="daily"); }
    else { candidates = pool.filter(p=>p.tag==="closing"); }
  }
  current = candidates[Math.floor(Math.random()*candidates.length)];
  qEl.textContent = current.q;
  debitSel.value = accounts[0].name;
  const firstNotCash = accounts.find(a=>a.name!=="現金");
  creditSel.value = firstNotCash ? firstNotCash.name : accounts[0].name;
  amountInp.value = "";
  explainBox.style.display = "none";
  setStatus("","");
}

// 採点
function check(){
  if(!current){ setStatus("先にスタートしてください。","ng"); return; }
  const d = debitSel.value; const c = creditSel.value; const a = Number(amountInp.value||0);
  if(!a){ setStatus("金額を入力してください。","ng"); return; }
  if(d===c){ setStatus("借方と貸方が同じ科目です。","ng"); return; }
  const correct = (d===current.d && c===current.c && a===current.a);
  if(correct){ ok++; setStatus("正解！","ok"); } else { ng++; setStatus("不正解。正解を確認しましょう。","ng"); }
  answered++; updateScore(); showExplain();
  if(mode==="exam"){ examRemaining = Math.max(0, examRemaining-1); if(examRemaining===0){ finishExam(false); } }
}

// 解説
function showExplain(){
  if(!current) return;
  explainBox.style.display = "block";
  const html = `
    <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center">
      <div class="center"><b>借方</b></div><div></div><div class="center"><b>貸方</b></div>
      <div class="center" style="font-size:1.05rem">${current.d}</div>
      <div class="center">＝ <b>${Number(current.a).toLocaleString()}</b> 円 ＝</div>
      <div class="center" style="font-size:1.05rem">${current.c}</div>
    </div>
    <div style="margin-top:8px">${current.exp}</div>
    <div class="muted" style="margin-top:6px">（増減規則の確認：資産/費用→増は借方、負債/純資産/収益→増は貸方）</div>
  `;
  explainBody.innerHTML = html;
}

// 仕訳帳
function recordJournal(){
  if(!current){ setStatus("先にスタートしてください。","ng"); return; }
  const d = debitSel.value; const c = creditSel.value; const a = Number(amountInp.value||0);
  if(!a){ setStatus("金額を入力してください。","ng"); return; }
  const date = new Date();
  const y = date.getFullYear(), m=String(date.getMonth()+1).padStart(2,'0'), day=String(date.getDate()).padStart(2,'0');
  const tr = document.createElement('tr');
  tr.innerHTML = `<td>${y}/${m}/${day}</td><td>${mode==="exam"?"本番":"練習"}</td><td>${current.q}</td><td>${d}</td><td>${a.toLocaleString()}</td><td>${c}</td><td>${a.toLocaleString()}</td>`;
  journalBody.prepend(tr);
  // T勘定
  ledger[d] = ledger[d] || {debit:0, credit:0};
  ledger[c] = ledger[c] || {debit:0, credit:0};
  ledger[d].debit += a; ledger[c].credit += a; renderLedger();
  setStatus("仕訳帳に記録しました。","ok");
}
function exportTableCSV(tableId, filename){
  const rows = Array.from(document.querySelectorAll(`#${tableId} tr`)).map(tr=>Array.from(tr.children).map(td=>td.innerText.replaceAll(',','')));
  const csv = rows.map(r=>r.map(x=>(/,|\"|\n/.test(x)?`"${x.replaceAll('"','""')}"`:x)).join(',')).join('\n');
  const blob = new Blob(["\ufeff"+csv],{type:"text/csv"});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click(); URL.revokeObjectURL(a.href);
}

// T勘定描画
function renderLedger(){
  tBody.innerHTML="";
  const entries = Object.entries(ledger).sort((a,b)=>a[0].localeCompare(b[0],'ja'));
  for(const [acc, val] of entries){
    const diff = val.debit - val.credit;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${acc}</td><td>${val.debit.toLocaleString()}</td><td>${val.credit.toLocaleString()}</td><td>${diff.toLocaleString()}</td>`;
    tBody.appendChild(tr);
  }
}

// セッション開始（※スコアやタイマーはここで初期化）
function start(){
  mode = modeSel.value;
  ok=0; ng=0; answered=0; updateScore(); setStatus("","");

  if(mode==="exam"){
    examTotal = Number(examCountSel.value)||40;
    examRemaining = examTotal;
    progressEl.textContent = `0/${examTotal}`;
    startTime = Date.now();
    startTimer(Number(timeLimitSel.value)||60);
  }else{
    examTotal = 0; examRemaining = 0; progressEl.textContent = "—";
    stopTimer(); timerEl.textContent = "--:--";
  }
  pick(); // 最初の1問を表示
}

// 次の問題（※スコア・タイマーはリセットしない）
function nextQuestion(){
  if(!current){ setStatus("先にスタートしてください。","ng"); return; }
  pick();
}

// 終了
function finishExam(timeup){
  stopTimer();
  const duration = startTime? Math.round((Date.now()-startTime)/1000) : 0;
  const mins = Math.floor(duration/60), secs = duration%60;
  const rate = (ok+ng)? Math.round(ok*100/(ok+ng)) : 0;
  // 履歴保存
  const hist = JSON.parse(localStorage.getItem('shiwake_hist')||'[]');
  hist.unshift({
    at: new Date().toLocaleString(),
    mode: mode==="exam" ? (timeup? "本番（時間切れ）" : "本番") : "練習",
    total: mode==="exam" ? examTotal : (ok+ng),
    ok, ng, rate,
    duration: mode==="exam" ? `${mins}分${secs}秒` : "-"
  });
  localStorage.setItem('shiwake_hist', JSON.stringify(hist));
  loadHist();
  setStatus(`終了：正解 ${ok} / ${ok+ng}（正答率 ${rate}%）` + (timeup? "｜時間切れ":""), timeup? "ng":"ok");
}

// UIイベント
document.getElementById('startBtn').addEventListener('click', start);
document.getElementById('nextBtn').addEventListener('click', nextQuestion);
document.getElementById('checkBtn').addEventListener('click', check);
document.getElementById('showBtn').addEventListener('click', showExplain);
document.getElementById('recordBtn').addEventListener('click', recordJournal);
document.getElementById('finishBtn').addEventListener('click', ()=>{ if(mode==="exam") finishExam(false); else setStatus("練習モードは随時終了できます。",""); });
document.getElementById('resetBtn').addEventListener('click', ()=>{ ok=0; ng=0; updateScore(); setStatus("スコアをリセットしました。",""); });
document.getElementById('exportJournal').addEventListener('click', ()=>exportTableCSV('journalTable','journal.csv'));
document.getElementById('exportHist').addEventListener('click', ()=>exportTableCSV('histTable','history.csv'));
document.getElementById('clearHist').addEventListener('click', ()=>{ localStorage.removeItem('shiwake_hist'); loadHist(); });

// チートシート描画
(function(){
  const tbody = document.getElementById('cheats');
  cheatRows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td class="muted">${r[3]}</td>`;
    tbody.appendChild(tr);
  });
})();

// 初期表示（未スタート時はダミー表示）
pick();
updateScore();
renderLedger();
</script>
</body>
</html>